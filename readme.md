## UnixNetwork

based on mysqlcpp-connector

首先安装最新libmysqlcppconn-dev。

Download latest mysql-apt-config deb from `https://repo.mysql.com/`

Install mysql-apt-config deb:
```shell
sudo dpkg -i mysql-apt-config_*.deb
sudo apt-get update
sudo apt-get install libmysqlcppconn-dev
```

---

此项目为聊天服务器，该服务器以当前社交软件为参考，以命令行形式模拟了用户交互。
该项目支持多人聊天，群聊，私聊，并支持一些命令请求，如添加好友或建立群命名，同时支持命令应答，以及文件收发。

该项目关键技术如下：
* 自定义了6字节长度的协议，保证数据完整性和高效；
* 使用ET模式的epoll作为socket io管理；
* 使用mysql存储离线消息，和用户信息（账号，密码）；
* 使用多线程以及线程池；
* 对于客户端来说，主线程主要在epoll_wait循环中，副线程显示和发送消息；
* 对于服务器来说，当用户登陆信息正确时，就使用线程池加载mysql数据，并生成报文数据准备发送客户端；


---
具体流程如下，客户端发送带有Sign_in标识的登陆信息，并陷入阻塞。服务器将收到的Sign_in的报文信息与mysql中匹配，如果成功，就发送DATA报文。该报文包含了客户信息，包括好友列表，以及群房间及其成员列表，并将发送给这个客户端的离线消息也重新发送。当客户端收到DADA报文段就唤醒副线程准备交互。默认客户端在`主页面`这个页面可以选择聊天对象，以及添加好友，并且显示未读消息，当客户选择一个聊天对象进行对话的时候（一个聊天对话框使用ChatRoom结构体表示），首先在本地查找历史记录并加载显示。此时客户可以和这个聊天对象交流。如果发送的是文本数据，则直接std::cout，如果发送的是文件，就保存在本地。

对于服务器来说，如果收到的Sign_in的信息有误就发送NO数据段，当收到一条聊天消息时候，首先查看对方是否`在线` 如果没有在线就保存至mysql中记录。


---

本项目使用协议如下，每个消息都有一个头文件，客户端和服务器端收到消息，先读取6字节的信息，判断协议是否匹配，在根据协议中的数据长度，读取相应的数据大小。

```

|+++++++|+++++++++|++++++++++++++|++++++++++++++++++++++++++++++++++++++++++++++++++++++++++|

|version|data type|     options  |                   data length				     		|								

|++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++|

|  4    |   4 	 |      8        |                          32                           	|

|++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++|
```



**4位开头，4位数据类型，8位选项，32位数据大小（最大4g文件）， 20字节的发送方名称，20字节的接收方名称，[数据]**  

```
TEXT =1,
PICTURE,
SOUND,
VIDEO,
FRIEND,  //对应添加好友请求
ROOM,   //对应群聊请求
YES,    // 对前两个请求的响应
NO,     // 对前面请求的响应
OTHER,
Sign_up,
Sign_in,
DATA  // 获取客户信息，如好友等。
```

   

文件说明：

Account, 存储用户好友及其群员信息。

ChatRoom， 包含两个结构体，ChatRoom表示聊天室，以及message_body封装消息，方便编解码

Sql 用于访问mysql

config 包含消息类型

Client 客户端

ThreadPool 线程池

Server 服务器





---



## TODO 
将添加redis作为mysql的缓存。
